<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            text-align: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç */
        }
        p {
            width: 300px;
            margin: 30px auto;
        }
        h1 { color: var(--tg-theme-text-color); }
        label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; text-align: left; }
        input[type="tel"], button {
            width: 100%; max-width: 300px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            padding: 12px; margin-bottom: 20px; border-radius: 8px;
            border: 1px solid var(--tg-theme-hint-color);
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            box-sizing: border-box;
            font-size: 1em;
        }
        button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            cursor: pointer;
            font-size: 1.1em;
            border: none;
            transition: background-color 0.2s;
        }
        button:active {
            filter: brightness(0.9);
        }
        #restore-form {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        input[readonly] {
            background-color: var(--tg-theme-bg-color) !important;
            border: 1px solid;
            color: var(--tg-theme-hint-color);
            cursor: default;
            opacity: 0.7;
        }

        input[readonly]:focus {
            outline: none;
        }

        #status-message {
            max-width: 300px;
            width: 100%;
            margin: 20px auto;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: none;
            font-size: 0.95em;
        }

        #status-message.success {
            background-color: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: var(--tg-theme-text-color);
        }

        #status-message.error {
            background-color: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            color: var(--tg-theme-text-color);
        }

        #status-message.loading {
            background-color: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.5);
            color: var(--tg-theme-text-color);
        }

        #result-display {
            max-width: 300px;
            width: 100%;
            margin: 20px auto;
            padding: 15px;
            border-radius: 8px;
            background-color: var(--tg-theme-secondary-bg-color);
            border: 1px solid var(--tg-theme-hint-color);
            display: none;
            text-align: left;
            font-size: 0.9em;
            word-wrap: break-word;
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <h1>üíæ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</h1>
    <p>–í–≤–µ–¥–∏—Ç–µ <b><u>–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</u></b>, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Å—Ç–∞—Ä–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫.</p>

    <form id="restore-form">

        <label for="phone" style="max-width: 300px;">–ù–æ–º–µ—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞:</label>
        <input type="tel" id="phone" placeholder="+1234567890" required>

        <label for="act_phone">–¢–µ–∫—É—â–∏–π –Ω–æ–º–µ—Ä:</label>
        <input type="tel" id="act_phone" readonly required>
        <button type="submit" id="submit-btn" style="display: block; width: 100%; max-width: 300px; padding: 15px; margin-top: 25px; margin-bottom: 10px; border-radius: 8px; background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); cursor: pointer; font-size: 1.1em; border: none;">–ù–∞–π—Ç–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </form>

    <div id="status-message"></div>
    <div id="result-display"></div>

    <script>
        const WebApp = window.Telegram.WebApp;
        WebApp.ready();

        const urlParams = new URLSearchParams(window.location.search);
        const actualPhone = urlParams.get('act_phone');

        try {
            const urlParams = new URLSearchParams(window.location.search);
            const actualPhone = urlParams.get('act_phone');
            document.getElementById('act_phone').value = ("+" + actualPhone) || '+9876543210';
        } catch (e) {
            document.getElementById('act_phone').value = '+1010101010';
        }

        // --- –§–£–ù–ö–¶–ò–ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –°–¢–ê–¢–£–°–ê ---
        function showStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = type;
            statusEl.style.display = 'block';
        }

        function hideStatus() {
            const statusEl = document.getElementById('status-message');
            statusEl.style.display = 'none';
        }

        function showResult(data) {
            const resultEl = document.getElementById('result-display');
            resultEl.innerHTML = '<strong>–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:</strong><br><pre>' + JSON.stringify(data, null, 2) + '</pre>';
            resultEl.style.display = 'block';
        }

        function hideResult() {
            const resultEl = document.getElementById('result-display');
            resultEl.style.display = 'none';
        }

        function sendRestoreData() {
            const form = document.getElementById('restore-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            hideStatus();
            hideResult();

            const restoreData = {
                action: 'restore',
                old_phone: document.getElementById('phone').value,
                act_phone: document.getElementById('act_phone').value
            };
            const urlParams = new URLSearchParams(window.location.search);
            const apiBase = urlParams.get('api') || 'http://127.0.0.1:8003';

            // –ü–æ–ª—É—á–∞–µ–º tg_id –∏–∑ WebApp.initDataUnsafe.user.id
            const tgUser = WebApp.initDataUnsafe && WebApp.initDataUnsafe.user ? WebApp.initDataUnsafe.user : null;
            const tgId = tgUser && tgUser.id ? tgUser.id : null;
            if (!tgId) {
                showStatus('‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à Telegram ID. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ –±–æ—Ç–∞.', 'error');
                WebApp.showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à Telegram ID. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ –±–æ—Ç–∞.');
                return;
            }

            const payload = {
                tg_id: tgId,
                old_phone: restoreData.old_phone,
                act_phone: restoreData.act_phone
            };

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
            showStatus('‚è≥ –ü–æ–∏—Å–∫ –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...', 'loading');
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = '–ü–æ–∏—Å–∫...';

            fetch(`${apiBase}/api/restore`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(async (res) => {
                let responseData;
                try {
                    responseData = await res.json();
                } catch (e) {
                    const text = await res.text();
                    responseData = { detail: text };
                }
                
                if (res.ok) {
                    showStatus('‚úÖ –ê–∫–∫–∞—É–Ω—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –ó–∞–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "‚úÖ –ì–æ—Ç–æ–≤–æ" –≤ –±–æ—Ç–µ.', 'success');
                    showResult(responseData);
                    WebApp.showAlert('üéâ –ê–∫–∫–∞—É–Ω—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –ó–∞–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "‚úÖ –ì–æ—Ç–æ–≤–æ" –≤ –±–æ—Ç–µ.');
                    submitBtn.textContent = '‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!';
                    submitBtn.style.backgroundColor = 'rgba(76, 175, 80, 0.8)';
                    submitBtn.disabled = true;
                } else {
                    const errorMsg = responseData.detail || responseData.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    showStatus('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ' + errorMsg, 'error');
                    showResult(responseData);
                    WebApp.showAlert('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ' + errorMsg);
                    submitBtn.textContent = '–ù–∞–π—Ç–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                    submitBtn.disabled = false;
                }
            }).catch((e) => {
                const errorMsg = '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + e.message;
                showStatus('‚ùå ' + errorMsg, 'error');
                showResult({ error: e.message, stack: e.stack });
                WebApp.showAlert(errorMsg);
                submitBtn.textContent = '–ù–∞–π—Ç–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                submitBtn.disabled = false;
            });
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–æ–±—ã—Ç–∏—é SUBMIT —Ñ–æ—Ä–º—ã HTML
        document.getElementById('restore-form').onsubmit = function(e) {
            e.preventDefault();
            sendRestoreData();
        };

        // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–Ω–æ–ø–∫–µ
        document.getElementById('submit-btn').onclick = function(e) {
            e.preventDefault();
            sendRestoreData();
        };
    </script>
</body>
</html>