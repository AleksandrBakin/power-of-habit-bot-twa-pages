<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
    <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background-color: var(--tg-theme-bg-color); /* –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω –∏–∑ —Ç–µ–º—ã Telegram */
            color: var(--tg-theme-text-color); /* –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç –∏–∑ —Ç–µ–º—ã Telegram */
            text-align: center;
        }

        h1 {
            color: var(--tg-theme-text-color);
            margin-bottom: 5px;
        }

        p {
            max-width: 300px;
            margin: 10px auto 30px auto;
            text-align: center;
            color: var(--tg-theme-hint-color); /* –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É—Å–∫–ª—ã–π —Ü–≤–µ—Ç –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
        }

        /* –û–±—â–∞—è —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∞ —Ñ–æ—Ä–º—ã */
        #registration-form {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ======================================= */
        /* –°–¢–ò–õ–ò –ü–û–õ–ï–ô –ò –õ–ï–ô–ë–õ–û–í */
        /* ======================================= */

        label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            max-width: 300px;
            width: 100%;
            text-align: left;
            font-size: 0.9em;
        }

        input[type="text"],
        input[type="time"],
        input[type="tel"]{

            width: 100%;
            max-width: 300px;
            padding: 12px;
            margin-bottom: 5px; /* –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –≤–ª–µ–∑–ª–∞ */
            border-radius: 8px;
            font-size: 1em;

            /* –°—Ç–∏–ª—å "–í —Ä–∞–º–∫–∞—Ö" —Å —Ü–≤–µ—Ç–∞–º–∏ Telegram */
            border: 1px solid var(--tg-theme-hint-color);
            background-color: var(--tg-theme-secondary-bg-color); /* –í—Ç–æ—Ä–∏—á–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –ø–æ–ª–µ–π */
            color: var(--tg-theme-text-color);
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        /* –í—ã–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—è –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
        input[type="text"]:focus,
        input[type="time"]:focus,
        input[type="tel"]:focus {
            border-color: var(--tg-theme-link-color); /* –¶–≤–µ—Ç —Å—Å—ã–ª–∫–∏ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
            outline: none;
        }

        input[readonly] {
            background-color: var(--tg-theme-bg-color) !important;
            border: 1px solid;
            color: var(--tg-theme-hint-color);
            cursor: default;
            opacity: 0.7;
        }

        input[readonly]:focus {
            outline: none;
        }

        button[type="submit"] {
            width: 100%;
            max-width: 300px;
            padding: 15px;
            margin-top: 25px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-sizing: border-box;

            background-color: var(--tg-theme-button-color); /* –¶–≤–µ—Ç –∫–Ω–æ–ø–∫–∏ Telegram */
            color: var(--tg-theme-button-text-color); /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏ Telegram */
            cursor: pointer;
            font-size: 1.1em;
            border: none;
            transition: background-color 0.2s;
        }

        button[type="submit"]:active {
            filter: brightness(0.9);
        }

        #agreement-container {
            display: flex;
            align-items: flex-start;
            max-width: 300px;
            width: 100%;
            margin-top: 10px;
            text-align: left;
        }

        #agreement-container input[type="checkbox"] {
            min-width: 20px;
            height: 20px;
            margin-right: 10px;
            margin-top: 0;
            flex-shrink: 0;
        }

        #agreement-container label {
            display: inline;
            font-weight: normal;
            font-size: 0.9em;
            margin: 0;
        }

        #agreement-container a {
            color: var(--tg-theme-link-color); /* –¶–≤–µ—Ç —Å—Å—ã–ª–∫–∏ Telegram */
            text-decoration: underline;
        }

        #status-message {
            max-width: 300px;
            width: 100%;
            margin: 20px auto;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: none;
            font-size: 0.95em;
        }

        #status-message.success {
            background-color: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: var(--tg-theme-text-color);
        }

        #status-message.error {
            background-color: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            color: var(--tg-theme-text-color);
        }

        #status-message.loading {
            background-color: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.5);
            color: var(--tg-theme-text-color);
        }

        #result-display {
            max-width: 300px;
            width: 100%;
            margin: 20px auto;
            padding: 15px;
            border-radius: 8px;
            background-color: var(--tg-theme-secondary-bg-color);
            border: 1px solid var(--tg-theme-hint-color);
            display: none;
            text-align: left;
            font-size: 0.9em;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
    <p>–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.</p>

    <form id="registration-form">

        <label for="user_name">–í–∞—à–µ –∏–º—è:</label>
        <input type="text" id="user_name" placeholder="–ò–º—è" required>

        <label for="timezone">–í–∞—à —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å (–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):</label>
        <input type="text" id="timezone" readonly required>

        <label for="reminder_time">–£—Ç—Ä–µ–Ω–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–ü–æ –≤–∞—à–µ–º—É —á–∞—Å–æ–≤–æ–º—É –ø–æ—è—Å—É):</label>
        <input type="time" id="reminder_time" value="10:00" required>

        <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
        <input type="tel" id="phone" readonly required>

        <div id="agreement-container">
            <input type="checkbox" id="agreement" required>
            <label for="agreement">–Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å
                <a href="https://drive.google.com/file/d/1DyufgbxchKKQPRqsoXywGEX3vCwpfGPV/view"
                   target="_blank">—É—Å–ª–æ–≤–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è,</a>
                <a href="https://drive.google.com/file/d/11mFImzeQd37ftmxtYOuctkQ6r-a1fAdw/view"
                   target="_blank">–ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
                –∏ –¥–∞—é —Å–≤–æ—ë —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.</label>
        </div>
        <button type="submit" id="submit-btn" style="display: block; width: 100%; max-width: 300px; padding: 15px; margin-top: 25px; margin-bottom: 10px; border-radius: 8px; background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); cursor: pointer; font-size: 1.1em; border: none;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    </form>

    <div id="status-message"></div>
    <div id="result-display"></div>
    <script>
        const WebApp = window.Telegram.WebApp;
        WebApp.ready();

        // --- –§–£–ù–ö–¶–ò–Ø –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –ß–ê–°–û–í–û–ì–û –ü–û–Ø–°–ê ---
        try {
            const localTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            document.getElementById('timezone').value = localTimezone || 'Etc/UTC';
        } catch (e) {
            document.getElementById('timezone').value = 'Etc/UTC';
        }

        try {
            const urlParams = new URLSearchParams(window.location.search);
            const phoneNumber = urlParams.get('phone_number');
            document.getElementById('phone').value = ("+" + phoneNumber) || '+9876543210';
        } catch (e) {
            document.getElementById('phone').value = '+1010101010';
        }

        // --- –§–£–ù–ö–¶–ò–Ø –ü–†–ï–î–ó–ê–ü–û–õ–ù–ï–ù–ò–Ø –ò–ú–ï–ù–ò ---
        if (WebApp.initDataUnsafe && WebApp.initDataUnsafe.user) {
            const user = WebApp.initDataUnsafe.user;

            // –ß–∏—Å—Ç—ã–π –º–µ—Ç–æ–¥ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è (filter(Boolean) —É–±–∏—Ä–∞–µ—Ç null/undefined)
            const fullName = [user.first_name, user.last_name].filter(Boolean).join(' ');

            document.getElementById('user_name').value = fullName;

            // –ù–∞–¥–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤—ã–≤–µ—Å—Ç–∏ —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç—É—Ç
            const photoUrl = WebApp.initDataUnsafe.user.photo_url
        }

        // --- –§–£–ù–ö–¶–ò–ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –°–¢–ê–¢–£–°–ê ---
        function showStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = type;
            statusEl.style.display = 'block';
        }

        function hideStatus() {
            const statusEl = document.getElementById('status-message');
            statusEl.style.display = 'none';
        }

        function showResult(data) {
            const resultEl = document.getElementById('result-display');
            resultEl.innerHTML = '<strong>–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:</strong><br><pre>' + JSON.stringify(data, null, 2) + '</pre>';
            resultEl.style.display = 'block';
        }

        function hideResult() {
            const resultEl = document.getElementById('result-display');
            resultEl.style.display = 'none';
        }

        // --- –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –î–ê–ù–ù–´–• ---
        function sendDataFromForm() {
            const form = document.getElementById('registration-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            hideStatus();
            hideResult();

            const registrationData = {
                action: 'register',
                name: document.getElementById('user_name').value,
                timezone: document.getElementById('timezone').value,
                reminder_time: document.getElementById('reminder_time').value,
                phone_number: document.getElementById('phone').value
            };
            const urlParams = new URLSearchParams(window.location.search);
            const apiBase = urlParams.get('api') || 'http://127.0.0.1:8003';

            // –ü–æ–ª—É—á–∞–µ–º tg_id –∏–∑ WebApp.initDataUnsafe.user.id
            const tgUser = WebApp.initDataUnsafe && WebApp.initDataUnsafe.user ? WebApp.initDataUnsafe.user : null;
            const tgId = tgUser && tgUser.id ? tgUser.id : null;
            if (!tgId) {
                showStatus('‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à Telegram ID. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ –±–æ—Ç–∞.', 'error');
                WebApp.showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à Telegram ID. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ –±–æ—Ç–∞.');
                return;
            }

            const payload = {
                tg_id: tgId,
                name: registrationData.name,
                phone_number: registrationData.phone_number,
                time_zone: registrationData.timezone,
                morning_reminder_time: registrationData.reminder_time,
                personal_data_use_agreement_time: new Date().toISOString()
            };

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
            showStatus('‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...', 'loading');
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

            fetch(`${apiBase}/api/users/${tgId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(async (res) => {
                let responseData;
                try {
                    responseData = await res.json();
                } catch (e) {
                    const text = await res.text();
                    responseData = { detail: text };
                }
                
                if (res.ok) {
                    showStatus('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –ó–∞–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "‚úÖ –ì–æ—Ç–æ–≤–æ" –≤ –±–æ—Ç–µ.', 'success');
                    showResult(responseData);
                    WebApp.showAlert('üéâ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –ó–∞–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "‚úÖ –ì–æ—Ç–æ–≤–æ" –≤ –±–æ—Ç–µ.');
                    submitBtn.textContent = '‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ!';
                    submitBtn.style.backgroundColor = 'rgba(76, 175, 80, 0.8)';
                    submitBtn.disabled = true;
                } else {
                    const errorMsg = responseData.detail || responseData.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    showStatus('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + errorMsg, 'error');
                    showResult(responseData);
                    WebApp.showAlert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + errorMsg);
                    submitBtn.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
                    submitBtn.disabled = false;
                }
            }).catch((e) => {
                const errorMsg = '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + e.message;
                showStatus('‚ùå ' + errorMsg, 'error');
                showResult({ error: e.message, stack: e.stack });
                WebApp.showAlert(errorMsg);
                submitBtn.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
                submitBtn.disabled = false;
            });
        }

        // --- –ù–ê–°–¢–†–û–ô–ö–ê –ö–ù–û–ü–û–ö –ò –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í (–û–î–ò–ù –†–ê–ó) ---

        // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–æ–±—ã—Ç–∏—é SUBMIT —Ñ–æ—Ä–º—ã HTML
        document.getElementById('registration-form').onsubmit = function(e) {
            e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
            sendDataFromForm(); // –í—ã–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏
        };

        // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–Ω–æ–ø–∫–µ
        document.getElementById('submit-btn').onclick = function(e) {
            e.preventDefault();
            sendDataFromForm();
        };
    </script>
</body>
</html>